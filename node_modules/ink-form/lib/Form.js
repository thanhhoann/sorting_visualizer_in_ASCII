"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Form = void 0;
var ink_1 = require("ink");
var react_1 = require("react");
var React = __importStar(require("react"));
var FormHeader_1 = require("./FormHeader");
var FormFieldRenderer_1 = require("./FormFieldRenderer");
var DescriptionRenderer_1 = require("./DescriptionRenderer");
var canSubmit_1 = require("./canSubmit");
var SubmitButton_1 = require("./SubmitButton");
var Form = function (props) {
    var _a;
    var isControlled = props.value !== undefined;
    var _b = react_1.useState(0), currentTab = _b[0], setCurrentTab = _b[1];
    var _c = react_1.useState((_a = props.value) !== null && _a !== void 0 ? _a : {}), value = _c[0], setValue = _c[1];
    var _d = react_1.useState(), editingField = _d[0], setEditingField = _d[1];
    var canSubmitForm = react_1.useMemo(function () { return canSubmit_1.canSubmit(props.form, value); }, [value, props.form]);
    var focusManager = ink_1.useFocusManager();
    react_1.useEffect(function () {
        focusManager.enableFocus();
    }, []);
    react_1.useEffect(function () {
        if (props.value) {
            setValue(props.value);
        }
    }, [props.value]);
    react_1.useEffect(function () {
        // Set initial values
        if (!isControlled) {
            setValueAndPropagate(__assign(__assign({}, value), props.form.sections
                .map(function (section) {
                return section.fields
                    .map(function (field) {
                    var _a;
                    return (field.initialValue !== undefined ? (_a = {}, _a[field.name] = field.initialValue, _a) : {});
                })
                    .reduce(function (obj1, obj2) { return (__assign(__assign({}, obj1), obj2)); }, {});
            })
                .reduce(function (obj1, obj2) { return (__assign(__assign({}, obj1), obj2)); }, {})));
        }
    }, []);
    var setValueAndPropagate = function (value) {
        var _a;
        setValue(value);
        (_a = props.onChange) === null || _a === void 0 ? void 0 : _a.call(props, value);
    };
    ink_1.useInput(function (input, key) {
        if (key.upArrow) {
            focusManager.focusPrevious();
        }
        else if (key.downArrow) {
            focusManager.focusNext();
        }
    }, { isActive: !editingField });
    return (React.createElement(ink_1.Box, { width: "100%", height: "100%", flexDirection: "column" },
        React.createElement(FormHeader_1.FormHeader, __assign({}, props, { currentTab: currentTab, onChangeTab: setCurrentTab, editingField: editingField })),
        !editingField && props.form.sections[currentTab].description && (React.createElement(ink_1.Box, { marginX: 4 },
            React.createElement(DescriptionRenderer_1.DescriptionRenderer, { description: props.form.sections[currentTab].description }))),
        React.createElement(ink_1.Box, { flexDirection: "column" }, currentTab > props.form.sections.length - 1
            ? null
            : props.form.sections[currentTab].fields.map(function (field) { return (React.createElement(FormFieldRenderer_1.FormFieldRenderer, { field: field, key: field.name, form: props.form, value: value[field.name], onChange: function (v) {
                    var _a;
                    return setValueAndPropagate(__assign(__assign({}, value), (_a = {}, _a[field.name] = v, _a)));
                }, onSetEditingField: setEditingField, editingField: editingField, customManagers: props.customManagers })); })),
        !editingField && (React.createElement(ink_1.Box, { flexDirection: "row-reverse" },
            React.createElement(SubmitButton_1.SubmitButton, { canSubmit: canSubmitForm, onSubmit: function () { var _a; return (_a = props.onSubmit) === null || _a === void 0 ? void 0 : _a.call(props, value); } })))));
};
exports.Form = Form;
